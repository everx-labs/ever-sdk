# Add EVER to your Exchange

## Introduction

This document describes the various ways to accomplish the most important tasks of running a crypto exchange that supports EVER.

There are a few different ways to accomplish the necessary tasks:

* Blockchain access may be set up either through the [Evercloud](https://docs.everos.dev/evernode-platform/products/evercloud/get-started) or through your own  node - the [DApp server](https://docs.everos.dev/evernode-platform/products/dapp-server-ds).
* Deposit account management can be accomplished either through the [TONOS-CLI ](https://github.com/tonlabs/tonos-cli)command line tool or integrate into your backend with  EVER-SDK client libraries. Both of these approaches are compatible with either of the blockchain access setups.

## Setting up Blockchain Access

There are two ways you can set up access to the Everscale blockchain: you may use [Evercloud](https://docs.everos.dev/evernode-platform/products/evercloud/get-started), or set up your own [DApp server](https://docs.everos.dev/evernode-platform/products/dapp-server-ds).

### Using Evercloud

Using [Evercloud](https://docs.everos.dev/evernode-platform/products/evercloud/get-started) allows you to work with Everscale blockchain and the Development Network without having to run your own node. TONOS-CLI and SDK can connect to it, as if it were a regular node. It has the same API as a node, and provides all capabilities required for running an exchange.

This page lists the [cloud endpoints](https://docs.everos.dev/ever-sdk/reference/ever-os-api/networks). To get access credentials go through this [guide](https://docs.everos.dev/evernode-platform/products/evercloud/get-started).

Whenever you have to specify a network endpoint in the examples given below, use the endpoints you receive in the [Evercloud dashboard](https://dashboard.evercloud.dev/projects).

{% hint style="info" %}
Note: We highly recommend testing out the full setup on the developer network first.
{% endhint %}

### Using DApp Server&#x20;

If you prefer to run your own node, you may set up your own [DApp server](https://docs.everos.dev/evernode-platform/products/dapp-server-ds). It is a client node, that may be set up on your own servers and provide full access to either Everscale or the Developer network. To connect to it with TONOS-CLI or SDK, it needs to have a domain name and a DNS record. You can specify its URL whenever you have to set the network in the examples given below.

Get the setup scripts in this repository: [https://github.com/tonlabs/evernode-ds](https://github.com/tonlabs/evernode-ds)

#### 1. System Requirements&#x20;

| Configuration | CPU (cores) | RAM (GiB) | Storage (GiB) | Network (Gbit/s) |
| ------------- | ----------- | --------- | ------------- | ---------------- |
| Recommended   | 24          | 128       | 2000          | 1                |

SSD disks are recommended for storage.



#### 2. Prerequisites&#x20;

**2.1 Set the Environment**&#x20;

Set the network in `/scripts/env.sh`: use `main.ton.dev` for the main network and `net.ton.dev` for the developer network.

{% hint style="info" %}
**Note**: We highly recommend testing out the full setup on the developer network first.&#x20;
{% endhint %}

```shell
$ cd TON-OS-DApp-Server/scripts/ 
$ . ./env.sh 
```

#### 2.2 Install Dependencies&#x20;

Ubuntu 20.04:

```shell
$ ./install_deps.sh
```

**Note**: Make sure to add your user to the docker group, or run subsequent command as superuser:

```shell
sudo usermod -a -G docker $USER
```

#### 2.3 Deploy Full Node

Deploy full node:

```shell
$ ./deploy.sh 2>&1 | tee ./deploy.log
```

**Note**: the log generated by this command will be located in the `TON-OS-DApp-Server/scripts/` folder and can be useful for troubleshooting.

## Setting up Deposit Account&#x20;

Currently we can recommend the formally verified [SafeMultisig](https://github.com/tonlabs/ton-labs-contracts/tree/master/solidity/safemultisig) contract for use in deposit accounts. It is well tested and secure, supports multiple custodians, and can be set up to require several independent signatures for any transfers. However it has certain limitations, that may prove problematic for exchanges: it is not possible to send tokens transfers in batches to multiple addresses.

If this functionality is required, you can develop a contract with the needed capabilities or get one developed by someone in the Everscale community.

### Using command line tool&#x20;

[TONOS-CLI](https://github.com/tonlabs/tonos-cli), the command line tool for the Everscale blockchain, allows to deploy any smart contracts to the blockchain, call all contract methods, sign transactions, and generally manage an account.

TONOS-CLI has versions for Linux, Windows and Mac.

It supports the Evercloud and DApp server-based approaches both.

#### 1. Install TONOS-CLI&#x20;

You can use [EVERDEV](https://docs.everos.dev/everdev/) to install the latest version of TONOS-CLI:

```shell
everdev tonos-cli install
```

It requires [NPM](https://docs.npmjs.com/downloading-and-installing-node-js-and-npm) to be installed, so it can install packages globally without using sudo. In case of error, manually set the environment variable

```shell
PATH=$PATH:$HOME./everdev/solidity 
```

#### 2. Set the network&#x20;

Use the following command to set the network:

```shell
tonos-cli config --url <https://network_url>

```

You may specify either your DApp Server URL, or one of the cloud endpoints:

* developer network for testing with test tokens. By default, TONOS-CLI connects to the developer network. We highly recommend testing out the full setup on this network first.&#x20;
* main Everscale network. Switch to it for working with EVERS.

You need to set the network only once before you start using the utility.

{% hint style="info" %}
**Note**: You should run the TONOS-CLI utility only from the folder where the tonos-cli.conf.json file is located.&#x20;
{% endhint %}

#### 3. Get contract files&#x20;

To use the recommended SafeMultisig, get the contract files:

**.tvc** - Compiled contract code

SafeMultisigWallet.tvc direct link:

{% embed url="https://github.com/tonlabs/ton-labs-contracts/raw/master/solidity/safemultisig/SafeMultisigWallet.tvc" %}

**.abi.json** - application binary interface, describing the functions of the contract

SafeMultisigWallet.abi.json direct link:

{% embed url="https://raw.githubusercontent.com/tonlabs/ton-labs-contracts/master/solidity/safemultisig/SafeMultisigWallet.abi.json" %}

#### 4. Create account seed phrase&#x20;

To generate your seed phrase enter the following command:

```shell
tonos-cli genphrase 
```

Terminal displays the generated seed phrase:

```shell
$ tonos-cli genphrase
Config: default
Succeeded.
Seed phrase: "spoon doll recipe regular list window cage joke stock clown mass glare"
```

If the deposit account needs to have multiple custodians, each of them has to generate their own seed phrase.

#### 5. Generate public key&#x20;

To generate your public key enter the following command with your previously generated seed phrase in quotes:

```shell
tonos-cli genpubkey "<seed_phrase>"
```

If the deposit account needs to have several custodians, each of them should generate their public key and send it to whomever will be deploying the account.

```shell
$ tonos-cli genpubkey "spoon doll recipe regular list window cage joke stock clown mass glare"
Config: default
Succeeded.
Public key: 352a248222c18d5c87d0e998d3c44ab324d21578f4068028af9b49005d2c9859
```

#### 5. Generate deployment key pair file&#x20;

Any custodian who has received the public keys of all other custodians can deploy the contract to the blockchain.

To create the key pair file from the seed phrase use the following command:

```shell
tonos-cli getkeypair <deploy.keys.json> "<seed_phrase>" 
```

`<deploy.keys.json>` - the file the key pair will be written to.

The utility generates the file that contains the key pair produced from seed phrase.

```shell
$ tonos-cli getkeypair deploy.keys.json "spoon doll recipe regular list window cage joke stock clown mass glare"
Config: default
Input arguments:
key_file: deploy.keys.json
  phrase: spoon doll recipe regular list window cage joke stock clown mass glare
Succeeded.
```

#### 7. Generate account address&#x20;

Use deployment key pair file to generate your address:

```shell
tonos-cli genaddr SafeMultisigWallet.tvc SafeMultisigWallet.abi.json --setkey <deploy.keys.json>
```

`<deploy.keys.json>` - the file the key pair is read from.

The utility displays the new deposit account address (Raw address).

```shell
$ tonos-cli genaddr SafeMultisigWallet.tvc SafeMultisigWallet.abi.json --setkey deploy.keys.json
Config: default
Input arguments:
     tvc: SafeMultisigWallet.tvc
      wc: None
    keys: deploy.keys.json
init_data: None
is_update_tvc: None

Raw address: 0:703546ac78f2b9d58f1072d131ff9fc23f29aeddcc85fd30bcba64f475b306a2
testnet:
Non-bounceable address (for init): 0QBwNUasePK51Y8QctEx_5_CPymu3cyF_TC8umT0dbMGot4F
Bounceable address (for later access): kQBwNUasePK51Y8QctEx_5_CPymu3cyF_TC8umT0dbMGooPA
mainnet:
Non-bounceable address (for init): UQBwNUasePK51Y8QctEx_5_CPymu3cyF_TC8umT0dbMGomWP
Bounceable address (for later access): EQBwNUasePK51Y8QctEx_5_CPymu3cyF_TC8umT0dbMGojhK
Succeeded
```

#### 8. Send tokens to the new address from another account&#x20;

Before deployment, an account needs to be sponsored with a small amount of tokens. You may use any convenient method to send tokens to the calculated address. For example, sending tokens from multisig wallets through TONOS-CLI is described [here](https://github.com/tonlabs/ton-labs-contracts/tree/master/solidity/safemultisig#46-create-transaction-online). Note, that if the wallet has multiple custodians, the transaction may require [confirmation](https://github.com/tonlabs/ton-labs-contracts/tree/master/solidity/safemultisig#47-create-transaction-confirmation-online) from the other custodians.

#### 9. Deploy the contract to blockchain Use the following command:

```shell
tonos-cli deploy SafeMultisigWallet.tvc '{"owners":["0x...", ...],"reqConfirms":N}' --abi SafeMultisigWallet.abi.json --sign <deploy_seed_or_keyfile>
```

Configuration parameters:

`owners` - array of custodian public keys generated by all account custodians at step 5 as uint256 numbers. Make sure all public keys are enclosed in quotes and start with 0x....

Example of how to specify custodian keys:

```shell
"owners":["0x8868adbf012ebc349ced852fdcf5b9d55d1873a68250fae1be609286ddb962582","0xa0e16ccff0c7bf4f29422b33ec1c9187200e9bd949bb2dd4c7841f5009d50778a"]
```

`reqConfirms` - number of signatures needed to confirm a transaction ( 0 < `N` ≤ custodian count). For accounts with a single custodian set reqConfirms:1

`<deploy_seed_or_keyfile>` - can either be the seed phrase used in step 6 to generate the deployment key pair file or the `deploy.keys.json` file itself. If seed phrase is used, enclose it in double quotes.

Example:

```shell
$ tonos-cli deploy --sign deploy.keys.json --abi SafeMultisigWallet.abi.json SafeMultisigWallet.tvc '{"owners":["0x88c541e9a1c173069c89bcbcc21fa2a073158c1bd21ca56b3eb264bba12d9340"],"reqConfirms":1}'
Config: /home/user/tonos-cli.conf.json
Input arguments:
     tvc: SafeMultisigWallet.tvc
  params: {"owners":["0x88c541e9a1c173069c89bcbcc21fa2a073158c1bd21ca56b3eb264bba12d9340"],"reqConfirms":1}
     abi: SafeMultisigWallet.abi.json
    keys: deploy.keys.json
      wc: 0
Connecting to net.ton.dev
Deploying...
Transaction succeeded.
Contract deployed at address: 0:703546ac78f2b9d58f1072d131ff9fc23f29aeddcc85fd30bcba64f475b306a2
```



### Using SDK&#x20;

You may integrate above described process of deposit account deployment into your exchange backend. The functionality is supported in SDK.

A sample is available in [this repository](https://github.com/tonlabs/sdk-samples/tree/master/demo/exchange) and an overview is given below.

{% hint style="info" %}
[Bindings](https://github.com/tonlabs/sdk-samples/tree/master/demo/exchange) for a large number of languages have been developed for SDK.&#x20;
{% endhint %}

Note, that similar to the TONOS-CLI approach described above, you have to sponsor a deposit account before deploying contract code. The sample requires you to input the data for a preexisting multisig account on the developer network to server as a giver.

The recommended [SafeMultisig](https://github.com/tonlabs/ton-labs-contracts/tree/master/solidity/safemultisig) contract is used.

```javascript

 async function main(client) {
    // Сonfigures the specified multisig wallet as a wallet to sponsor deploy operation
    const giver = await ensureGiver(client);

    // Generate a key pair for a wallet that we will deploy
    console.log("Generate new wallet keys");
    const walletKeys = await client.crypto.generate_random_sign_keys();

    // In this example we will deploy safeMultisig wallet.
    // Read about it here https://github.com/tonlabs/ton-labs-contracts/tree/master/solidity/safemultisig

    // The first step - initialize new account object with ABI,
    // target network (client) and previously generated key pair (signer) and 
    // calculate future wallet address so that we can sponsor it before deploy.
    // Read more about deploy and other basic concepts here https://everos.dev/faq/blockchain-basic
    const wallet = await getAccount(client, SafeMultisigContract, signerKeys(walletKeys));

    // Save last master block seq_no before we send the first transaction.
    // It will be used later as starting point for pagination reqest.
    const lastSeqNo = await getLastMasterBlockSeqNoByTime(client, seconds());

    // Prepay contract before deploy.
    console.log(`Sending deploy fee from giver wallet ${giver.address} to the new account at ${wallet.address}`);
    await depositAccount(wallet.address, 500_000_000, client);

    console.log(`Deploying new wallet at ${wallet.address}`);
    // Now lets deploy safeMultisig wallet
    // Here we specify 1 custodian and 1 reqConfirms
    // but in real life there can be many custodians as well and more than 1 required confirmations
    await deployAccount(wallet,  {
        owners: [`0x${walletKeys.public}`], // constructor parameters of multisig
        reqConfirms: 1,
    });
  
 /**
 * Initializes Giver Account that will be used to topup other accounts before deploy.
 *
 * SafeMultisig wallet is used. If you want to use another contract as Giver -
 * read more about how to add a contract to a project here
 * https://docs.everos.dev/ever-sdk/guides/work_with_contracts/add_contract_to_your_app
 */
async function ensureGiver(client) {
    if (_giver) {
        return _giver;
    }
    const address = process.argv[2];
    const secret = process.argv[3];
    if (!address || !secret) {
        console.log("USE: node index <giver-address> <giver-secret-key>");
        console.log("Giver must be a multisig wallet");
        process.exit(1);
    }
    _giver = await getAccount(
        client,
        SafeMultisigContract,
        signerKeys({
            public: (await client.crypto.nacl_sign_keypair_from_secret_key({ secret }))
                .secret.substr(64),
            secret,
        }),
    );
    _giver.address = address;
    return _giver;
}
    
async function getAccount(client, contract, signer) {
    const abi = abiContract(contract.abi);

    // Let's create deploy message to calculate future contract address
    // We do not use `call_set` parameter here because it does not affect address calculation
    const address = (await client.abi.encode_message({
        abi,
        signer: signer,
        deploy_set: {
            tvc: contract.tvc,
        },
    })).address;
    return {
        client,
        address,
        abi,
        tvc: contract.tvc,
        signer,
    };
}

async function getLastMasterBlockSeqNoByTime(client, utime) {
    return (await client.net.query({
        query: `query MyQuery($utime: Int){
            blockchain {
                master_seq_no_range(time_end: $utime) { end }
            }
        }`,
        variables: {utime},
    })).result.data.blockchain.master_seq_no_range.end
}

/**
 * Topup an account for deploy operation.
 *
 * We need an account which can be used to deposit other accounts.
 * We call it "giver".
 *
 * This sample uses already deployed multisig wallet with positive balance as a giver.
 *
 * In production you can use any other contract that can transfer funds, as a giver.
 */
async function depositAccount(address, amount, client) {
    return await walletSend(await ensureGiver(client), address, amount);
}

/**
 * Sends some tokens from msig wallet to specified address.
 */
async function walletSend(wallet, address, amount) {
    return await runAndWaitForRecipientTransactions(wallet, "sendTransaction", {
        dest: address,
        value: amount,
        bounce: false,
        flags: 1,
        payload: "",
    });
}

async function runAndWaitForRecipientTransactions(account, functionName, input) {
    const runResult = await account.client.processing.process_message({
        message_encode_params: {
            address: account.address,
            abi: account.abi,
            signer: account.signer,
            call_set: {
                function_name: functionName,
                input,
            },
        },
        send_events: false,
    });

    const transactions = [];

    // This step is only required if you want to know when the recipient actually receives their tokens.
    // In Everscale blockchain, transfer consists of 2 transactions (because the blockchain is asynchronous):
    //  1. Sender sends tokens - this transaction is returned by `Run` method
    //  2. Recipient receives tokens - this transaction can be caught with `query_transaction_tree method`
    // Read more about transactions and messages here
    // https://everos.dev/faq/blockchain-basic
    let countCallingApi = 0;
    while(transactions.length === 0 && countCallingApi < 100) {
        for (const messageId of runResult.transaction.out_msgs) {
            const tree = await account.client.net.query_transaction_tree({
                in_msg: messageId,
            });
            transactions.push(...tree.transactions);
            if (countCallingApi++) {
                await sleep(200); // don't spam API
            }
        }
    }
    return transactions;
}


async function deployAccount(
    account,
    constructorInput,
) {
    return await account.client.processing.process_message({
        message_encode_params: {
            abi: account.abi,
            signer: account.signer,
            deploy_set: {
                tvc: account.tvc,
            },
            call_set: {
                function_name: "constructor",
                input: constructorInput,
            },
        },
        send_events: false,
    });
}
```



## Monitoring Deposit Account&#x20;

An exchange needs to reliably know when customers deposit funds into its exchange accounts. This functionality has been integrated into SDK. A sample is available in [this repository](https://github.com/tonlabs/sdk-samples/tree/master/demo/exchange) and an overview of the relevant part is given below.

In this sample JS SDK is used. [Bindings](https://github.com/tonlabs/sdk-samples/tree/master/demo/exchange) for a large number of languages have been developed for SDK.&#x20;

The script iterates over all blocks since the specified time and looks for transfers according to the set up filters. Transfers may be filtered by one or all accounts.

```javascript
    ...
    // To build a query with pagination, let's limit the count of transactions
    // which will be obtained by one request
    const countLimit = 10;

    // And here we retrieve all the wallet's transactions since the specified block seq_no
    // Due to blockchain multi-sharded nature its data needs some time to reach consistency
    // for reliable pagination. This is why we use `for` here, waiting for the last transaction
    // in the list
    let size = 0;
    console.log(`\nTransactions for ${wallet.address} account since block(seq_no):${lastSeqNo}`);
    for await (let transactions of queryAccountTransactions(client, wallet.address, {seq_no: lastSeqNo, count: countLimit})) {
        transactions.forEach(printTransfers);
        size += transactions.length;
        if (size >= 4) {
            // Wait 4 transactions:
            //   1. Sending deploy fee
            //   2. Deploying new wallet
            //   3. Depositing 2 tokens
            //   4. Withdrawing 1 token
            break;
        }
    }
    ...
    
    // Now let's iterate all blockchain transactions with value transfers.
    // Starting from master seq_no which was generated 10 minuts ago.
    const afterSeqNo = await getLastMasterBlockSeqNoByTime(client, seconds(Date.now() - 10*60*1000));
    console.log(`\nTransactions of all accounts`);
    for await (let transactions of queryAllTransactions(client, {seq_no: afterSeqNo, count: countLimit})) {
        // Trying get next trnsactions which contain any valuable transfers
        if (!hasTransfersOnTransactions(transactions)) {
            continue;
        }

        transactions.forEach(printTransfers);

        try {
            await keyPress();
        } catch(_) {
            // If pressed Ctrl+C exits from iteration
            break;
        }
    }
    
    async function getLastMasterBlockSeqNoByTime(client, utime) {
    return (await client.net.query({
        query: `query MyQuery($utime: Int){
            blockchain {
                master_seq_no_range(time_end: $utime) { end }
            }
        }`,
        variables: {utime},
    })).result.data.blockchain.master_seq_no_range.end
    }
    
    
/**
 * Iterator to query account transactions by using cursor-based pagination.
 */
async function *queryAccountTransactions(
    client,
    address,
    options,
) {
    const variables = {
        address,
        cursor: null,
        ...options,
    }
    while (true) { // <-- !WARNING! Infinity loop, you need to implement condition to exit from iterator
        const transactions = await internalQueryTransactions(client, variables);
        yield transactions.edges.map(_ => _.node);
        variables.cursor = transactions.pageInfo.endCursor || variables.cursor;
        await sleep(200); // don't spam API
    }
}
    
    async function internalQueryTransactions(client, variables) {
    const isAccount = "address" in variables;
    const query = isAccount ? queryAccouont : queryAll;
    const response = await client.net.query({query, variables});
    return isAccount ?
        response.result.data.blockchain.account.transactions
        :
        response.result.data.blockchain.transactions;
}

// This API has additional consistency checks to ensure consistent pagination, which can lead to additional delay
const queryAccouont = `query MyQuery($address: String!, $cursor: String, $count: Int, $seq_no: Int) {
    blockchain {
        account(address: $address){
            transactions(
                master_seq_no_range: {
                    start: $seq_no
                }
                first: $count
                after: $cursor
            ){
                edges{
                    node{
                        ${TRANSACTION_FIELDS}
                    }
                }
                pageInfo{
                    endCursor
                }
            }
        }
    }
}`;

// This API has additional consistency checks to ensure consistent pagination, which can lead to additional delay
const queryAll = `query MyQuery($cursor: String, $count: Int, $seq_no: Int) {
    blockchain {
        transactions(
            master_seq_no_range: {
                start: $seq_no
            }
            first: $count
            after: $cursor
        ){
            edges{
                node{
                    ${TRANSACTION_FIELDS}
                }
            }
            pageInfo{
                endCursor
            }
        }
    }
}`;
```

You may test out the demo application running this process on the developer network by cloning the [sdk-samples](https://github.com/tonlabs/sdk-samples) repository, and running the following commands in the /demo/exchange folder

```shell
npm i
node index giverAddress giverPrivateKey
```

Read more about giverAddress and giverPrivateKey parameters in the sample readme.&#x20;

## Withdrawing from deposit accounts&#x20;

The specific function that is used to send the funds to the user depends on the contract chosen for the deposit account. Below are provided the examples for the [SafeMultisig](https://github.com/vtchemodanov/tondev/blob/patch-2/docs/deploy\_mulisig\_tondev.md) contract.

Using command line tool [TONOS-CLI](add\_to\_exchange.md#using-command-line-tool) tool may be used to implement withdrawals from deposit account.

The simplest way that bypasses any verification and places all risks entirely on the user is to send the full requested amount with a single transfer to the specified address. If the user made a mistake in the address, and has no control over it, these funds will be lost. If the account does not exist, and the user makes mistakes deploying it after the funds are transferred, they may end up being lost as well.

To perform a simple transfer to any account, whether it already exists or not, use the following TONOS-CLI command:

```shell
tonos-cli call <deposit_account_address> submitTransaction '{"dest":"recipient_address","value":<nanotokens>,"bounce":false,"allBalance":false,"payload":""}' --abi SafeMultisigWallet.abi.json --sign <seed_or_keyfile>
```

&#x20;`"recipient_address"` - raw address of the recipient smart contract. Example: `"0:f22e02a1240dd4b5201f8740c38f2baf5afac3cedf8f97f3bd7cbaf23c7261e3"`

`"value"`: - amount of tokens to transfer in nanotokens (Example: "value":10000000000 sets up a transfer of 10 tokens).

`"bounce"` - use false to transfer funds to any account regardless of whether it exists.

`"payload"` - use "" for simple transfer.

`"allBalance"` - used to transfer all funds in the wallet. Use false for a simple transfer.

{% hint style="info" %}
**Note**: Due to a bug setting `allBalance` to `true` currently causes errors. Single-custodian multisig wallets may use `sendTransaction` method with flag `130` and value `0` instead:
{% endhint %}

```shell
tonos-cli call <multisig_address> sendTransaction '{"dest":"raw_address","value":0,"bounce":true,"flags":130,"payload":""}' --abi <MultisigWallet.abi.json> --sign <seed_or_keyfile>
```

`<seed_or_keyfile>` - can either be the custodian seed phrase or the corresponding custodian key pair file. If seed phrase is used, enclose it in double quotes.

Example:

`--sign "flip uncover dish sense hazard smile gun mom vehicle chapter order enact"`

or

`--sign keyfile.json`

Example:

```shell
$ tonos-cli call 0:a4629d617df931d8ad86ed24f4cac3d321788ba082574144f5820f2894493fbc submitTransaction '{"dest":"0:0c5d5215317ec8eef1b84c43cbf08523c33f69677365de88fe3d96a0b31b59c6","value":234000000,"bounce":false,"allBalance":false,"payload":""}' --abi SafeMultisigWallet.abi.json --sign k1.keys.json
Config: /home/user/tonos-cli.conf.json
Input arguments:
 address: 0:a4629d617df931d8ad86ed24f4cac3d321788ba082574144f5820f2894493fbc
  method: submitTransaction
  params: {"dest":"0:0c5d5215317ec8eef1b84c43cbf08523c33f69677365de88fe3d96a0b31b59c6","value":234000000,"bounce":false,"allBalance":false,"payload":""}
     abi: SafeMultisigWallet.abi.json
    keys: k1.keys.json
lifetime: None
  output: None
Connecting to net.ton.dev
Generating external inbound message...

MessageId: c6baac843fefe6b9e8dc3609487a63ef21207e4fdde9ec253b9a47f7f5a88d01
Expire at: Sat, 08 May 2021 14:52:23 +0300
Processing... 
Succeeded.
Result: {
  "transId": "6959885776551137793"
}
```

Note, that if your deposit account has multiple custodians, the transaction has to be confirmed by the required number of signatures to be executed. In this case transaction ID will be displayed as transaction result, when creating it. This transaction ID should be communicated to other custodians, who should use it to confirm the transaction.

#### (Optional) Confirm transaction&#x20;

To confirm a transaction, use the following command:

```shell
tonos-cli call <deposit_account_address> confirmTransaction '{"transactionId":"<id>"}' --abi SafeMultisigWallet.abi.json --sign <seed_or_keyfile>
```

`transactionId` – the ID of the transaction can be acquired from the custodian who created it.

`<seed_or_keyfile>` - can either be the custodian seed phrase or the corresponding custodian key pair file. If seed phrase is used, enclose it in double quotes.

Example:

`--sign "flip uncover dish sense hazard smile gun mom vehicle chapter order enact"`

or

`--sign keyfile.json`

Basic checks of the address format will be performed by the TONOS-CLI utility automatically, only addresses of a valid Everscale format will be accepted.

#### Mitigating risks of token loss due to user error

The are two main cases regarding transfers to user accounts: a user may already have an active account to which they want to withdraw funds, or they may want to withdraw funds to a completely new account, that doesn't exist at the time withdraw is requested.

The status of the account provided by the user may be checked with the following TONOS-CLI command:

```shell
tonos-cli account <accound_address>
```

Example of existing account:

```shell
$ tonos-cli account 0:255a3ad9dfa8aa4f3481856aafc7d79f47d50205190bd56147138740e9b177f3
Config: default
Input arguments:
 address: 0:255a3ad9dfa8aa4f3481856aafc7d79f47d50205190bd56147138740e9b177f3
Connecting to <https://net.ton.dev>
Processing...
Succeeded.
acc_type:      Active
balance:       542692817630
last_paid:     1622198835
last_trans_lt: 0x50cef81af04
data(boc): b5ee9c720101020100980001df8534c46f7a135058773fa1298cb3a299a5ddd40dafe41cb06c64f274da360bfb00000179b295c60dc29a6237bd09a82c3b9fd094c659d14cd2eeea06d7f20e583632793a6d1b05fd80000000000000000000000000000000000000000000000000000000000000002020000000001018010045a010a6988def426a0b0ee7f4253196745334bbba81b5fc83960d8c9e4e9b46c17f6010
code_hash: 207dc560c5956de1a2c1479356f8f3ee70a59767db2bf4788b1d61ad42cdad82


```

Example of account that doesn't exist yet:

```shell
$ tonos-cli account 0:255a3ad9dfa8aa4f3481856aafc7d79f47d50205190bd56147138740e9b177f4
Config: defaultsh
Input arguments:
 address: 0:255a3ad9dfa8aa4f3481856aafc7d79f47d50205190bd56147138740e9b177f4
Connecting to <https://net.ton.dev>
Processing...
Succeeded.
Account not found.
```

The possible results of this command are the following:

`Account not found` - account does not exist. It needs to be sponsored, then deployed, and only then will it be active.

`acc_type: Uninit` - account already has some funds on it but contract code has not been deployed yet. User needs to deploy it.

`acc_type: Active` - account already exists, and its code is deployed.

In the first to cases, the exchange might first transfer a small portion of the requested amount (\~1 EVER) and request that the user deploys their contract. Upon the user's confirmation that the account is deployed, its status may be rechecked, and if it became active, the remaining amount of requested funds may be safely transferred.

If the account is already active, a small portion of the requested amount may be transferred to the user, and the user may be asked what amount they received (note: a small amount of the transfer, usually less than 0.05 EVER, will be spent on fees, so it's best to ask for the whole number of tokens transferred). If the amounts match, the rest of the requested funds may be transferred as well.

#### PIN code verification&#x20;

Additionally, for users that use the [Surf](https://ever.surf/) app to store their tokens, PIN code verification is possible.

The following TONOS-CLI command may be used to send a transaction with an encrypted PIN code, which the user will be able to see in Surf:

```shell
tonos-cli multisig send --addr <deposit_account_address> --dest <recipient_address> --purpose <"PIN_code"> --sign <path_to_keys_or_seed_phrase> --value *number*js
```

`<deposit_account_address>` - address of the deposit account address that tokens are sent from.

`<recipient_address>` - address of the account tokens are sent to.

`<"PIN_code">` - accompanying message containing the PIN code. Only the recipient will be able to decrypt and read it. should be enclosed in double quotes.

`<path_to_keys_or_seed_phrase>` - path to sender wallet key file of the corresponding seed phrase in quotes.

\-`-value`` `_`number`_ - value to be transferred (in tokens).

Example:

```shell
$ tonos-cli multisig send --addr 0:255a3ad9dfa8aa4f3481856aafc7d79f47d50205190bd56147138740e9b177f3 --dest 0:a4629d617df931d8ad86ed24f4cac3d321788ba082574144f5820f2894493fbc --purpose "339" --sign key.json --value 6
Config: /home/user/tonos-cli.conf.json
Connecting to net.ton.dev
Generating external inbound message...

MessageId: 62b1420ac98e586f29bf79bc2917a0981bb3f15c4757e8dca65370c19146e327
Expire at: Thu, 13 May 2021 13:26:06 +0300
Processing... 
Succeeded.
Result: {
  "transId": "0"
}.
```

### Using SDK&#x20;

You may integrate withdrawals from deposit account into your backend using SDK as well. A sample is available in [this repository](https://github.com/tonlabs/sdk-samples/tree/master/demo/exchange) and an overview of the relevant part is given below.

In this sample JS SDK is used.  [Bindings](https://github.com/tonlabs/sdk-samples/tree/master/demo/exchange) for a large number of languages have been developed for SDK.&#x20;

This example shows how to generate a withdrawal transaction from a Multisig wallet, using its `sendTransaction` method. Note, that if Multisig has multiple custodians, the transaction will have to be confirmed with the `confirmTransaction` method.

You may choose from which account (sender or recipient), the forward fees will be charged.

In this example tokens are withdrawn from the deposit account to the giver, that initially sponsored it. In a proper implementation, the account given by user should be used instead.

```javascript
/**
 * Withdraws some tokens from Multisig wallet to a specified address.
 *
 * In case of 1 custodian `submitTransaction` method performs full withdraw operation.
 *
 * In case of several custodians, `submitTransaction` creates a transaction inside the wallet
 * for other custodians to confirm.
 * Other custodians need to invoke  `confirmTransaction` method for confirmation.
 * Once enough custodians confirm the transaction it will be withdrawn.
 * Read more how to work with multisig here
 * https://github.com/tonlabs/ton-labs-contracts/tree/master/solidity/safemultisig
 */
async function walletWithdraw(wallet, address, amount) {
    const transactions = await runAndWaitForRecipientTransactions(wallet, "submitTransaction", {
        dest: address,
        value: amount,
        bounce: false,
        allBalance: false,
        payload: "",
    });
    if (transactions.length > 0) {
        console.log(`Recipient received transfer. The recipient's transaction is: ${transactions[0].id}`);
    }
    return transactions
}
```

#### User account verification with SDK&#x20;

Same as described above, users of the [Surf](https://ever.surf/) app can be offered additional verification with a PIN code.

Below is a snippet of the [SDK sample](https://github.com/tonlabs/sdk-samples/tree/master/core-examples/node-js/transfer-with-comment) demonstrating how to generate a transaction with an encrypted comment. A PIN code can be transmitted to the user in this comment attached to a small amount of tokens, and only after the user provides the PIN code, thus proving they have access to their account, may the rest of the withdrawal amount be transferred.

```javascript
// Prepare body with comment
        // For that we need to prepare internal message with transferAbi and then extract body from it
        const body = (await client.abi.encode_message_body({
            abi: abiContract(transferAbi),
            call_set: {
                function_name: "transfer",
                input: {
                    comment: Buffer.from("My comment").toString("hex"),
                },
            },
            is_internal: true,
            signer: signerNone(),
        })).body;

        const multisig = new Account(MultisigContract, {
            signer: signerKeys(keyPair),
            client,
        });

        // Run 'submitTransaction' method of multisig wallet
        // Create run message

        console.log("Call `submitTransaction` function");
        const transactionInfo = (await multisig.run("submitTransaction", {
            dest: recipient,
            value: 100_000_000,
            bounce: false,
            allBalance: false,
            payload: body,
        }));
        console.log(transactionInfo);
        console.log("Transaction info:");

        console.log("Id:");
        console.log(transactionInfo.transaction.id);
        console.log("messages:");
        console.log(transactionInfo.out_messages);
        const messages = transactionInfo.out_messages;

        const decodedMessage1 = (await tonClient.abi.decode_message({
            abi: abiContract(transferAbi),
            message: messages[0],
        }));

        // Decode comment from hex to string
        decodedMessage1.value.comment = Buffer.from(decodedMessage1.value.comment, "hex").toString("utf8");

        console.log("Decoded message 1:", decodedMessage1.value);

        const decodedMessage2 = (await tonClient.abi.decode_message({
            abi: abiContract(multisigContractPackage.abi),
            message: messages[1],
        }));

        console.log("Decoded message 2:", decodedMessage2);
```
